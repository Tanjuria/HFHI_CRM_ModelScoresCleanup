<GlobalChangeSpec
  xmlns="bb_appfx_globalchange"
  xmlns:c="bb_appfx_commontypes"
  ID="07F58E17-0C93-45BA-B887-6EB147DCE176"
  Name="HFHI CRM Model Score Cleanup"
  Description="Ends older ADMA and SIMIO model score entries on a constituent when duplicates exist. Also ensures future updates apply a new start date and end the previous score."
  Author="HFHCON-DEV\twillis"
  DisplayName="HFHI CRM Model Score Cleanup"
  GlobalChangeFolder="HFHI CRM Model Score Maintenance"
  SPName="USR_USP_GLOBALCHANGE_HFHI_CRM_MODELSCORECU_v2">

	<CreateProcedureSQL>
		<![CDATA[

CREATE PROCEDURE dbo.USR_USP_GLOBALCHANGE_HFHI_CRM_MODELSCORECU_v2
(
    @CHANGEAGENTID UNIQUEIDENTIFIER = NULL,
    @ASOF DATETIME = NULL,
    @NUMBERADDED INT = 0 OUTPUT,
    @NUMBEREDITED INT = 0 OUTPUT,
    @NUMBERDELETED INT = 0 OUTPUT
)
AS
BEGIN
    SET NOCOUNT ON;

    IF @ASOF IS NULL
        SET @ASOF = GETDATE();

    DECLARE @CURRENTDATE DATETIME = @ASOF;

    IF @CHANGEAGENTID IS NULL
        EXEC dbo.USP_CHANGEAGENT_GETORCREATECHANGEAGENT @CHANGEAGENTID OUTPUT;

    -- Persona priority (ADMA only)
    IF OBJECT_ID('tempdb..#PERSONAPRIORITY') IS NOT NULL DROP TABLE #PERSONAPRIORITY;
    CREATE TABLE #PERSONAPRIORITY (VALUE NVARCHAR(100), PRIORITY INT);

    INSERT INTO #PERSONAPRIORITY (VALUE, PRIORITY)
    VALUES
        ('World Changers', 1),
        ('Movers + Shakers', 2),
        ('Busy Bees', 3),
        ('Happy-Go-Luckies', 4),
        ('Easy Goers', 5),
        ('Solid Citizens', 6),
        ('Everyday People', 7);

    DECLARE @SQL NVARCHAR(MAX) = '';

    -- ADMA table
    SET @SQL += '
    ;WITH DEDUP AS (
        SELECT A.ID, A.MODELINGANDPROPENSITYID, A.VALUE, A.STARTDATE, A.ENDDATE,
            ROW_NUMBER() OVER (
                PARTITION BY A.MODELINGANDPROPENSITYID
                ORDER BY ISNULL(P.PRIORITY, 99), COALESCE(A.STARTDATE, ''1900-01-01'') DESC
            ) AS RN
        FROM dbo.ATTRIBUTED1DBE44C8F734152BDED6C3723A96873 A
        LEFT JOIN #PERSONAPRIORITY P ON CONVERT(NVARCHAR(100), A.VALUE) = P.VALUE
        WHERE A.ENDDATE IS NULL
    )
    UPDATE T
    SET T.ENDDATE = ''' + CONVERT(NVARCHAR(20), @CURRENTDATE, 120) + ''',
        T.CHANGEDBYID = ''' + CONVERT(NVARCHAR(36), @CHANGEAGENTID) + ''',
        T.DATECHANGED = ''' + CONVERT(NVARCHAR(20), @CURRENTDATE, 120) + '''
    FROM dbo.ATTRIBUTED1DBE44C8F734152BDED6C3723A96873 T
    INNER JOIN DEDUP D ON D.ID = T.ID
    WHERE D.RN > 1;
    ';

    -- SIMIO Tables (no VALUE column)
    DECLARE @SIMIO_TABLES TABLE (NAME SYSNAME);
    INSERT INTO @SIMIO_TABLES (NAME)
    VALUES
        ('ATTRIBUTE628D8C79C5354CDEBA04853FF4D1129C'), -- Mid-Level
        ('ATTRIBUTE992C22EE8AF24ABF8E6AEF796C9EFFBB'), -- Net Worth
        ('ATTRIBUTEC14E96658FC544E0933F4DF1FA74CA6B'); -- Planned Giving

    DECLARE @TABLENAME SYSNAME;
    DECLARE SIMIO_CURSOR CURSOR FOR SELECT NAME FROM @SIMIO_TABLES;
    OPEN SIMIO_CURSOR;
    FETCH NEXT FROM SIMIO_CURSOR INTO @TABLENAME;

    WHILE @@FETCH_STATUS = 0
    BEGIN
        SET @SQL += '
        ;WITH DEDUP AS (
            SELECT A.ID, A.MODELINGANDPROPENSITYID, A.STARTDATE, A.ENDDATE,
                ROW_NUMBER() OVER (
                    PARTITION BY A.MODELINGANDPROPENSITYID
                    ORDER BY COALESCE(A.STARTDATE, ''1900-01-01'') DESC
                ) AS RN
            FROM dbo.' + QUOTENAME(@TABLENAME) + ' A
            WHERE A.ENDDATE IS NULL
        )
        UPDATE T
        SET T.ENDDATE = ''' + CONVERT(NVARCHAR(20), @CURRENTDATE, 120) + ''',
            T.CHANGEDBYID = ''' + CONVERT(NVARCHAR(36), @CHANGEAGENTID) + ''',
            T.DATECHANGED = ''' + CONVERT(NVARCHAR(20), @CURRENTDATE, 120) + '''
        FROM dbo.' + QUOTENAME(@TABLENAME) + ' T
        INNER JOIN DEDUP D ON D.ID = T.ID
        WHERE D.RN > 1;
        ';
        FETCH NEXT FROM SIMIO_CURSOR INTO @TABLENAME;
    END

    CLOSE SIMIO_CURSOR;
    DEALLOCATE SIMIO_CURSOR;

    EXEC sp_executesql @SQL;

    SET @NUMBERADDED = 0;
    SET @NUMBERDELETED = 0;
    SET @NUMBEREDITED = @@ROWCOUNT;
END;


    ]]>
	</CreateProcedureSQL>

	
</GlobalChangeSpec>

