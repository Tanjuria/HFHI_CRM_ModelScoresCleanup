<SQLFunctionSpec
	xmlns="bb_appfx_sqlfunction"
	xmlns:c="bb_appfx_commontypes" 
	ID="0133c8c5-f39a-4d12-b27d-4fe979b45b68"
	Name="USR_UFN_MODELSCORESFORCONSTITUENT_UPDATE"
	Description="Updated the function to output end dates"
	Author="HFHCON-DEV\twillis"
	DBFunctionName="USR_UFN_MODELSCORESFORCONSTITUENT_UPDATE"
	>

	<CreateFunctionSQL>
		<![CDATA[
CREATE FUNCTION dbo.USR_UFN_MODELSCORESFORCONSTITUENT_UPDATE(@CONSTITUENTID UNIQUEIDENTIFIER)

RETURNS TABLE
AS
RETURN
(
    -- ADMA likelihoods
    SELECT
        ROW_NUMBER() OVER (ORDER BY MP.DATECHANGED DESC) AS ANALYTICSMODELROWNUMBER,
        MP.ID AS ID,
        AM.NAME AS NAME,
        CASE AM.ID
            WHEN '3CF4EC5A-63FE-42EA-B70B-7F6CAAE286F1' THEN CAST(NULLIF(MP.ANNUALGIFTLIKELIHOOD, -1) AS NVARCHAR(50))
            WHEN '3788BA7E-E7DC-4A6E-93C9-F2245B26A13B' THEN CAST(NULLIF(MP.ANNUITYLIKELIHOOD, -1) AS NVARCHAR(50))
            WHEN 'DEF85E09-E51A-4EED-B8AF-0763272A5593' THEN CAST(NULLIF(MP.BEQUESTLIKELIHOOD, -1) AS NVARCHAR(50))
            WHEN 'FEB5BE0E-3B4F-45E1-A3E2-26F4372DEE96' THEN CAST(NULLIF(MP.CRTLIKELIHOOD, -1) AS NVARCHAR(50))
            WHEN 'CE8C3F19-6B9A-4852-AB3C-3765F48578F7' THEN CAST(NULLIF(MP.MAJORGIVINGLIKELIHOOD, -1) AS NVARCHAR(50))
            WHEN 'B2C12F11-3C63-4077-ADD0-C976A905B07C' THEN CAST(NULLIF(MP.MEMBERSHIPLIKELIHOOD, -1) AS NVARCHAR(50))
            WHEN '06776DBB-E33A-45A2-B1DE-972B626169DC' THEN CAST(NULLIF(MP.ONLINEGIVINGLIKELIHOOD, -1) AS NVARCHAR(50))
            WHEN '64111AFB-850D-4407-B403-948F0CD8BE25' THEN CAST(NULLIF(MP.PATIENTRESPONSELIKELIHOOD, -1) AS NVARCHAR(50))
            WHEN '2018E9DB-F837-4CC0-BFC9-E72E5E63ACB5' THEN CAST(NULLIF(MP.PLANNEDGIFTLIKELIHOOD, -1) AS NVARCHAR(50))
            ELSE NULL
        END AS SCORE,
        AM.MAXIMUMVALUE AS MAXIMUMSCORE,
        COALESCE(AP.DATE, CAST(MP.DATECHANGED AS DATE)) AS UPDATEDON,
        A.STARTDATE AS STARTDATE,
        A.ENDDATE AS ENDDATE,
        AM.ID AS ANALYTICSMODELID
    FROM dbo.MODELINGANDPROPENSITY MP
    INNER JOIN dbo.ANALYTICSMODEL AM ON 1=1
    LEFT JOIN dbo.ATTRIBUTED1DBE44C8F734152BDED6C3723A96873 A
        ON A.MODELINGANDPROPENSITYID = MP.ID
    LEFT JOIN dbo.MODELINGANDPROPENSITYDELIVERY MD
        ON MD.MODELINGANDPROPENSITYID = MP.ID AND MD.ANALYTICSMODELID = AM.ID
    LEFT JOIN dbo.ANALYTICSPROJECT AP
        ON AP.ID = MD.ANALYTICSPROJECTID
    WHERE MP.ID = @CONSTITUENTID

    UNION ALL

    -- SIMIO Mid-Level
    SELECT
        1 AS ANALYTICSMODELROWNUMBER,
        S.ID,
        'SIMIO Mid-Level' AS NAME,
        NULL AS SCORE,              -- value not stored in table
        NULL AS MAXIMUMSCORE,
        S.STARTDATE AS UPDATEDON,
        S.STARTDATE AS STARTDATE,
        S.ENDDATE,
        S.MODELINGANDPROPENSITYID AS ANALYTICSMODELID
    FROM dbo.ATTRIBUTE628D8C79C5354CDEBA04853FF4D1129C S
    WHERE S.MODELINGANDPROPENSITYID = @CONSTITUENTID

    UNION ALL

    -- SIMIO Net Worth
    SELECT
        1 AS ANALYTICSMODELROWNUMBER,
        S.ID,
        'SIMIO Net Worth' AS NAME,
        NULL AS SCORE,
        NULL AS MAXIMUMSCORE,
        S.STARTDATE AS UPDATEDON,
        S.STARTDATE AS STARTDATE,
        S.ENDDATE,
        S.MODELINGANDPROPENSITYID AS ANALYTICSMODELID
    FROM dbo.ATTRIBUTE992C22EE8AF24ABF8E6AEF796C9EFFBB S
    WHERE S.MODELINGANDPROPENSITYID = @CONSTITUENTID

    UNION ALL

    -- SIMIO Planned Giving
    SELECT
        1 AS ANALYTICSMODELROWNUMBER,
        S.ID,
        'SIMIO Planned Giving' AS NAME,
        NULL AS SCORE,
        NULL AS MAXIMUMSCORE,
        S.STARTDATE AS UPDATEDON,
        S.STARTDATE AS STARTDATE,
        S.ENDDATE,
        S.MODELINGANDPROPENSITYID AS ANALYTICSMODELID
    FROM dbo.ATTRIBUTEC14E96658FC544E0933F4DF1FA74CA6B S
    WHERE S.MODELINGANDPROPENSITYID = @CONSTITUENTID
);


		]]>
	</CreateFunctionSQL>

</SQLFunctionSpec>
